stages:
  - lint
  - test
  - publish

variables:
  UV_NO_SOURCES: "1"
  UV_EXTRA_INDEX_URL: "https://gitlab-ci-token:${CI_JOB_TOKEN}@gitlab.qodev.ai/api/v4/projects/${CI_PROJECT_ID}/packages/pypi/simple"

default:
  image: python:3.11-slim
  before_script:
    - apt-get update && apt-get install -y --no-install-recommends git
    - pip install uv
    - uv sync --all-extras

lint:
  stage: lint
  script:
    - uv run ruff check .
    - uv run ruff format --check .

typecheck:
  stage: lint
  script:
    - uv run mypy gitlab_mcp/

typos:
  stage: lint
  script:
    - uvx typos

test:unit:
  stage: test
  script:
    - uv run pytest tests/unit --cov=gitlab_mcp --cov-report=term

test:integration:
  stage: test
  script:
    - uv run pytest tests/integration -v
  when: manual
  allow_failure: true

publish:
  stage: publish
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+/
  before_script:
    - pip install uv
  script:
    - uv build
    - uv publish --publish-url "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/pypi" -u gitlab-ci-token -p "${CI_JOB_TOKEN}"
